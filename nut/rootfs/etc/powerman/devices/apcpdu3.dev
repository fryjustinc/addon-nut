# APC AP7900 series PDU device definition for PowerMan
# Enhanced version with better error handling

specification "apcpdu3" {
    timeout 15.0
    
    plug name { "1" "2" "3" "4" "5" "6" "7" "8" }
    
    script login {
        delay 0.5
        send "\r"
        expect "(User Name|Username|Login|>)"
        send "apc\r"
        expect "(Password|password)"
        send "apc\r"
        expect "(>|APC>)"
    }
    
    script logout {
        send "exit\r"
        expect "Connection closed"
    }
    
    script status {
        delay 0.1
        send "1\r"
        expect "Device Manager"
        send "1\r"
        expect "Outlet Management"
        send "1\r"
        expect "Outlet Control"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "([0-9]+)-.*(ON|OFF)"
        setplugstate $1 $2 on="ON" off="OFF"
        expect "Press <ENTER>"
        send "\r"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
    }
    
    script on {
        delay 0.1
        send "1\r"
        expect "Device Manager"
        send "1\r"
        expect "Outlet Management"
        send "2\r"
        expect "Outlet Control"
        send "%1\r"
        expect "Control Outlet"
        send "1\r"
        expect "turn outlet"
        expect "(Enter 'YES'|Y/N)"
        send "YES\r"
        expect "Press <ENTER>"
        send "\r"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
    }
    
    script off {
        delay 0.1
        send "1\r"
        expect "Device Manager"
        send "1\r"
        expect "Outlet Management"
        send "3\r"
        expect "Outlet Control"
        send "%1\r"
        expect "Control Outlet"
        send "1\r"
        expect "turn outlet"
        expect "(Enter 'YES'|Y/N)"
        send "YES\r"
        expect "Press <ENTER>"
        send "\r"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
    }
    
    script cycle {
        delay 0.1
        send "1\r"
        expect "Device Manager"
        send "1\r"
        expect "Outlet Management"
        send "4\r"
        expect "Outlet Control"
        send "%1\r"
        expect "Control Outlet"
        send "1\r"
        expect "reboot outlet"
        expect "(Enter 'YES'|Y/N)"
        send "YES\r"
        expect "Press <ENTER>"
        send "\r"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
        send "\033"
        expect ">"
    }
}
