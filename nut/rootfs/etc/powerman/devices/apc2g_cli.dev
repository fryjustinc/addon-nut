# APC RPDU2G (AP79xxB/AP8xxx 2G) CLI-driven specification for PowerMan
# Uses SSH interactive CLI (apc> prompt). Expects username prompt handled by ssh,
# password prompt matched here, and final prompt 'apc>'.

specification "apc2g_cli" {
    timeout 25.0

    plug name { "1" "2" "3" "4" "5" "6" "7" "8" }

    script login {
        # Wake the session to trigger prompts
        send "\r"
        delay 0.2
        send "\r"
        delay 0.2
        # Match either user, password, or prompt
        expect "(User Name *:|Username *:|Login *:|Password *:|apc>)"
        send "apc\r"
        # If we just sent username, expect password; if already at prompt, this will match immediately
        expect "(Password *:|apc>)"
        send "apc\r"
        # Final prompt
        expect "(apc>|APC>)"
    }

    script logout {
        send "exit\r"
    }

    # Query each outlet deterministically using CLI
    script status {
        # Ensure prompt
        send "\r"
        expect "(apc>|APC>)"

        send "olStatus 1\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 2\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 3\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 4\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 5\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 6\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 7\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 8\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"
    }

    # Control actions map to CLI commands
    script on {
        send "olOn %1\r"
        expect "apc>"
    }

    script off {
        send "olOff %1\r"
        expect "apc>"
    }

    script cycle {
        send "olReboot %1\r"
        expect "apc>"
    }
}


