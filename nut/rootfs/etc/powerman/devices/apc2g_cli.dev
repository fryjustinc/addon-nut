# APC RPDU2G (AP79xxB/AP8xxx 2G) CLI-driven specification for PowerMan
# Uses SSH interactive CLI (apc> prompt). Expects username prompt handled by ssh,
# password prompt matched here, and final prompt 'apc>'.

specification "apc2g_cli" {
    timeout 25.0

    plug name { "1" "2" "3" "4" "5" "6" "7" "8" }

    script login {
        # Handle either username or password or already-logged-in prompt
        expect "(User Name|Username|Login|Password|apc>)"
        send "apc\r"
        expect "(Password|apc>)"
        send "apc\r"
        expect "apc>"
    }

    script logout {
        send "exit\r"
    }

    # Query each outlet deterministically using CLI
    script status {
        expect "apc>"

        send "olStatus 1\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 2\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 3\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 4\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 5\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 6\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 7\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"

        send "olStatus 8\r"
        expect "([0-9]+).*: *(On|Off)"
        setplugstate $1 $2 on="On" off="Off"
        expect "apc>"
    }

    # Control actions map to CLI commands
    script on {
        send "olOn %1\r"
        expect "apc>"
    }

    script off {
        send "olOff %1\r"
        expect "apc>"
    }

    script cycle {
        send "olReboot %1\r"
        expect "apc>"
    }
}


